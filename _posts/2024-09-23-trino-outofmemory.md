---
title: "Trino ë©”ëª¨ë¦¬ ëˆ„ìˆ˜: Hadoop FileSystem Cacheì˜ í•¨ì •"
date: 2024-09-23
categories: [Trino, Hadoop, Performance]
tags: [trino, hadoop, oom, memory-leak, filesystem-cache, troubleshooting]
---

# Trino ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë¬¸ì œ í•´ê²°ê¸°: Hadoop FileSystem Cacheì˜ í•¨ì •

## ë“¤ì–´ê°€ë©°

Prestoì—ì„œ Trinoë¡œ ì „í™˜í•œ í›„ ì–¼ë§ˆ ì§€ë‚˜ì§€ ì•Šì•„ ì˜ˆìƒì¹˜ ëª»í•œ ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤. ì¿¼ë¦¬ ìš”ì²­ì´ ì¦ê°€í•˜ë©´ì„œ ì›Œì»¤ ë…¸ë“œë“¤ì´ ë©”ëª¨ë¦¬ ë¶€ì¡±(OOM)ìœ¼ë¡œ ì¸í•´ í•˜ë‚˜ë‘˜ì”© ì…§ë‹¤ìš´ë˜ê¸° ì‹œìž‘í–ˆê³ , í´ëŸ¬ìŠ¤í„° ì „ì²´ê°€ ë¶ˆì•ˆì •í•´ì§€ëŠ” ìƒí™©ì´ ë²Œì–´ì§„ ê²ƒì´ë‹¤. ë‹¨ìˆœí•œ ì„¤ì • ë¬¸ì œì¼ ê²ƒì´ë¼ê³  ìƒê°í–ˆì§€ë§Œ, ë¬¸ì œì˜ ê·¼ë³¸ ì›ì¸ì€ ìƒê°ë³´ë‹¤ í›¨ì”¬ ê¹Šì€ ê³³ì— ìˆ¨ì–´ìžˆì—ˆë‹¤.

ì´ ê¸€ì€ ê·¸ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ê³¼ì •ì—ì„œ ë°œê²¬í•œ Hadoop íŒŒì¼ì‹œìŠ¤í…œ ìºì‹œì˜ ì¹˜ëª…ì ì¸ ì„¤ê³„ ê²°í•¨ê³¼, ê·¸ê²ƒì´ ì–´ë–»ê²Œ ëŒ€ê·œëª¨ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ë¡œ ì´ì–´ì¡ŒëŠ”ì§€ì— ëŒ€í•œ ì´ì•¼ê¸°ë‹¤.

## ë¬¸ì œ ë°œìƒ

### ì²« ë²ˆì§¸ ì‹ í˜¸: ì›Œì»¤ ë…¸ë“œë“¤ì˜ ì—°ì‡„ ì…§ë‹¤ìš´

Trino ì›Œì»¤ë“¤ì´ ì›Œí¬ë¡œë“œë¥¼ ì²˜ë¦¬í•  ë•Œ OOMì„ ë°œìƒì‹œí‚¤ê³  ìžˆì—ˆë‹¤. ë‹¤ìŒì€ Trino ì›Œì»¤ì˜ JVM ì˜µì…˜ë“¤ì´ë‹¤.

![Trino JVM ì„¤ì •](https://github.com/user-attachments/assets/2f4ba3c1-5e31-4d51-874f-b02dd0b06b81)
*Trino ì›Œì»¤ì˜ JVM ì˜µì…˜ ì„¤ì • - jvm.config íŒŒì¼*

í´ëŸ¬ìŠ¤í„° ë¶ˆì•ˆì •ì˜ ì›ì¸ì´ ëª…í™•ížˆ OOMì´ì—ˆê¸° ë•Œë¬¸ì—, ì›Œì»¤ë“¤ì˜ JVM ì˜µì…˜ì— `-XX:+HeapDumpOnOutOfMemoryError` ì˜µì…˜ì„ í™œì„±í™”í–ˆë‹¤. ì´ì œ OOM ë°œìƒ ì‹œ Trino ìž‘ì—… ë””ë ‰í† ë¦¬ì— íž™ë¤í”„ê°€ ìƒì„±ëœë‹¤.

![Heam Dumping](https://github.com/user-attachments/assets/bd7568fc-ec23-4824-9d0f-1f6e5873e08d)

íž™ë¤í”„ë¥¼ ì‹œìž‘í•œë‹¤. ì´ ê³¼ì •ë™ì•ˆ ì´ ë…¸ë“œëŠ” out of service ìƒíƒœê°€ ëœë‹¤.

### íž™ë¤í”„ ìƒì„±ì˜ ë”œë ˆë§ˆ

í•˜ì§€ë§Œ ìƒˆë¡œìš´ ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤. íž™ë¤í”„ë¥¼ ìƒì„±í•˜ëŠ” ê³¼ì •ì—ì„œ ë˜ ë‹¤ë¥¸ ìž¥ì• ê°€ ì¼ì–´ë‚œ ê²ƒì´ë‹¤. Trino ì›Œí‚¹ë””ë ‰í† ë¦¬ê°€ `/mnt`ì— ë§ˆìš´íŠ¸ëœ EBS ë‚´ì— ìžˆì–´ì„œ, EBS ìš©ëŸ‰ì´ íž™ë¤í”„ë³´ë‹¤ ìž‘ì„ ê²½ìš° íž™ë¤í”„ í•˜ë‚˜ë§Œìœ¼ë¡œë„ ë””ìŠ¤í¬ ì‚¬ìš©ë¥ ì´ 100%ì— ë„ë‹¬í•˜ê²Œ ëœë‹¤. ì˜ˆë¥¼ ë“¤ì–´, 30GiB EBS ë””ìŠ¤í¬ê°€ ë§ˆìš´íŠ¸ëœ ë””ë ‰í† ë¦¬ì— 128GiB ë©”ëª¨ë¦¬ ì‚¬ì–‘ì˜ íž™ë¤í”„ê°€ ì €ìž¥ë˜ë©´ ìš©ëŸ‰ ë¶€ì¡±ìœ¼ë¡œ Trino ì„œë²„ê°€ ìž¬ì‹œìž‘ë˜ì§€ ëª»í•œë‹¤.

```text
...
[29055.159592] systemd-journald[2054]: Failed to open system journal: No space left on device

[29055.161253] systemd-journald[2054]: Failed to open system journal: No space left on device

[29055.162798] systemd-journald[2054]: Failed to open system journal: No space left on device

[29055.164404] systemd-journald[2054]: Failed to open system journal: No space left on device
...
```
*30GiB EBS ë””ìŠ¤í¬ì— 128GiB ë©”ëª¨ë¦¬ ì‚¬ì–‘ì˜ íž™ë¤í”„ê°€ ì €ìž¥ë˜ë©´ì„œ ë°œìƒí•œ "No space left on device" ì—ëŸ¬*

ì›Œì»¤ ì„œë²„ì˜ ë©”ëª¨ë¦¬ê°€ ëŒ€ë¶€ë¶„ 128GiBì˜€ê¸° ë•Œë¬¸ì— íž™ë¤í”„ì˜ í¬ê¸°ê°€ í¬ê³  ìƒì„± ì‹œê°„ë„ ì˜¤ëž˜ ê±¸ë ¸ë‹¤. ë”°ë¼ì„œ 8GiBì™€ ê°™ì´ ìƒëŒ€ì ìœ¼ë¡œ ìž‘ì€ ë©”ëª¨ë¦¬ë¥¼ ê°€ì§„ ì›Œì»¤ë§Œ ì‹¤í—˜ì ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„°ì— íˆ¬ìž…í•˜ì—¬ íž™ í¬ê¸°ë¥¼ ì¸¡ì •í•´ë³´ê¸°ë¡œ í–ˆë‹¤.

## ì¶”ì : ë¬¸ì œì˜ ì •ì²´ë¥¼ ì°¾ì•„ì„œ

### Prometheusì™€ Grafanaë¥¼ í†µí•œ ëª¨ë‹ˆí„°ë§

ë¬¸ì œì˜ íŒ¨í„´ì„ íŒŒì•…í•˜ê¸° ìœ„í•´ ê° ë…¸ë“œì˜ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ì„ ì¶”ì í–ˆë‹¤. Prometheusì—ì„œ ì§€í‘œë¥¼ ìˆ˜ì§‘í•˜ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì´ JVM ì˜µì…˜ì„ ì¶”ê°€í–ˆë‹¤:

```text
-javaagent:/usr/lib/trino/lib/jmx_prometheus_javaagent-1.0.1.jar=12345:/etc/trino/conf/jmx_exporter_config.yaml
```

`jmx_prometheus_javaagent.jar` íŒŒì¼ê³¼ `jmx_exporter_config.yaml`ì€ EMR ë¶€íŠ¸ìŠ¤íŠ¸ëž©ì„ í†µí•´ ì„¤ì¹˜í–ˆë‹¤. ì—ì´ì „íŠ¸ë¥¼ ì„¤ì¹˜í•˜ê³  Trino ì„œë²„ë¥¼ ì‹¤í–‰í•˜ë©´ Java ê¸°ë³¸ ì§€í‘œì™€ Trino ì»¤ìŠ¤í…€ ì§€í‘œë¥¼ ìˆ˜ì§‘í•  ìˆ˜ ìžˆì—ˆë‹¤.

![Grafana Dashboard](https://github.com/user-attachments/assets/14c3111f-d01d-47b2-b294-b5862e0e37bd)
*ë‹¤ì–‘í•œ Trino ì§€í‘œë“¤ì„ ë³´ì—¬ì£¼ëŠ” Grafana ëŒ€ì‹œë³´ë“œ - ë…¸ë“œ ìƒíƒœ, ì‹¤í–‰ ì¤‘ì¸ ì¿¼ë¦¬, ë©”ëª¨ë¦¬ ì˜ˆì•½ëŸ‰, ì‹¤í–‰ ì§€ì—°ì‹œê°„ ë“±*

### ë©”ëª¨ë¦¬ ì‚¬ìš© íŒ¨í„´ì˜ ë°œê²¬

Grafanaë¥¼ í†µí•´ ì›Œì»¤ì˜ Old ì˜ì—­ì´ ë§¤ìš° ê·œì¹™ì ì´ê³  ì ì§„ì ìœ¼ë¡œ ì ìœ ë˜ëŠ” ê²ƒì„ ê´€ì°°í•  ìˆ˜ ìžˆì—ˆë‹¤. ê²°êµ­ JVMì€ OOMìœ¼ë¡œ ì¸í•´ ì¢…ë£Œëœë‹¤.

![G1 Old Gen](https://github.com/user-attachments/assets/c4614826-7d36-4658-ac9d-c022f85d8a8c)
*Old ì˜ì—­ì´ ê³„ë‹¨ì‹ìœ¼ë¡œ ì ìœ ë˜ëŠ” í˜„ìƒê³¼ OOMìœ¼ë¡œ ì¸í•œ JVM ì¢…ë£Œ ì‹œì (ì´ë¹¨ ë¹ ì§„ ì˜ì—­ì€ JVMì´ OOMìœ¼ë¡œ ì¢…ë£Œë˜ê³  íž™ë¤í”„ë¥¼ ìƒì„±í•˜ëŠ” ì‹œê°„)*

Old ì˜ì—­ì´ ê³„ë‹¨ì‹ìœ¼ë¡œ ì ìœ ë˜ëŠ” í˜„ìƒì€ ê²½í—˜ìƒ ë‹¤ìŒ ë‘ ê°€ì§€ ì›ì¸ìœ¼ë¡œ ì¶”ì¸¡í•  ìˆ˜ ìžˆì—ˆë‹¤:
1. **ë©”ëª¨ë¦¬ ëˆ„ìˆ˜**
2. **ì• í”Œë¦¬ì¼€ì´ì…˜ ìºì‹œ**

ì´ì œ íž™ë¤í”„ë¥¼ ìƒì„¸ížˆ ë¶„ì„í•´ë³¼ ì‹œê°„ì´ì—ˆë‹¤.

### íž™ë¤í”„ ë¶„ì„ í™˜ê²½ êµ¬ì„±

> ðŸ’¡ **í° íž™ë¤í”„ ë¶„ì„ì€ MAT(Eclipse Memory Analyzer)ë¥¼ ì‚¬ìš©í•œë‹¤.**

*íž™ë¤í”„ ë¶„ì„ì„ ìœ„í•œ ëŒ€ìš©ëŸ‰ ë©”ëª¨ë¦¬ ìž¥ë¹„ ì„¤ì • ë° MAT ì„¤ì • ë°©ë²•*

- MAT ë‹¤ìš´ë¡œë“œ í›„, ì••ì¶•ì„ í‘¼ í›„ `ParseHeapDump.sh` ìŠ¤í¬ë¦½íŠ¸ ë§ˆì§€ë§‰ì— `-vmargs -Xmx80g -XX:-UseGCOverheadLimit` ì˜µì…˜ì„ ì¶”ê°€(íž™ë¤í”„ í¬ê¸°ë§Œí¼ ë©”ëª¨ë¦¬ ì„¤ì •)
- ë¶„ì„ì„ í†µí•´ ìƒì„±ëœ ì¸ë±ìŠ¤ íŒŒì¼ì„ ë¡œì»¬ ìž¥ë¹„ë¡œ ì˜®ê¸´ í›„, MATìœ¼ë¡œ ì—´ê¸°

### MAT ë¶„ì„ ê²°ê³¼

![MAT Analysis2](https://github.com/user-attachments/assets/ecaa29be-a15d-48bf-bbc4-1d60caa6d200)
*154,554ê°œì˜ `org.apache.hadoop.conf.Configuration` ì¸ìŠ¤í„´ìŠ¤ê°€ ë©”ëª¨ë¦¬ì˜ 62.15%ë¥¼ ì ìœ í•˜ê³  ìžˆìŒì„ ë³´ì—¬ì£¼ëŠ” MAT ë¶„ì„ ê²°ê³¼*

MAT ë¶„ì„ ê²°ê³¼, Suspect 1ì„ í•´ì„í•˜ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤:

- **`org.apache.hadoop.conf.Configuration`** ì¸ìŠ¤í„´ìŠ¤ê°€ ë©”ëª¨ë¦¬ ì ìœ ì˜ ì£¼ëœ ì›ì¸
- **ì¸ìŠ¤í„´ìŠ¤ ê°œìˆ˜**: 154,554ê°œ
- **ë©”ëª¨ë¦¬ ì ìœ **: 16,135,726,184 bytes (ì•½ 15.4 GB, 62.15%)
- **í´ëž˜ìŠ¤ ë¡œë”**: `io.trino.server.PluginClassLoader`

ê·¼ë³¸ ì›ì¸ì€ ì´ Configuration ê°ì²´ë“¤ì´ `java.util.HashMap$Node[]`ì— ì˜í•´ ì°¸ì¡°ë˜ê³  ìžˆìœ¼ë©°, ì´ HashMapì€ `org.apache.hadoop.fs.FileSystem$Cache` ê°ì²´ê°€ ì°¸ì¡°í•˜ê³  ìžˆë‹¤ëŠ” ì ì´ì—ˆë‹¤.

ìŠ¤ë ˆë“œ ì •ë³´ë¥¼ ë³´ë©´:
- **ìŠ¤ë ˆë“œ ì´ë¦„**: `20240904_071500_01656_d5p8v.1.5.0-548-61`
- **ì°¸ì¡° ê°ì²´**: `com.amazon.ws.emr.hadoop.fs.EmrFileSystem`
- **ìŠ¤ë ˆë“œ ë¡œì»¬ ë©”ëª¨ë¦¬**: 648,576 bytes (ë¬´ì‹œí•  ìˆ˜ ìžˆëŠ” í¬ê¸°)

ì •ë¦¬í•˜ë©´, `FileSystem$Cache` ê°ì²´ê°€ HashMapì„ í†µí•´ ìˆ˜ë§Žì€ `Configuration` ê°ì²´ë“¤ì„ ì°¸ì¡°í•˜ê³  ìžˆì–´ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ê°€ ë°œìƒí•˜ê³  ìžˆì—ˆë‹¤.

## ë¬¸ì œì˜ ê·¼ë³¸ ì›ì¸ ì¶”ì 

### ìŠ¤íƒíŠ¸ë ˆì´ìŠ¤ ë¶„ì„

![](https://github.com/user-attachments/assets/051f7509-5618-4027-905c-cecb358fbf1d)
*Splitì„ Pageë¡œ ë³€í™˜í•˜ëŠ” ê³¼ì •ì—ì„œ ë°œìƒí•œ OutOfMemory ìŠ¤íƒíŠ¸ë ˆì´ìŠ¤*

ìŠ¤íƒíŠ¸ë ˆì´ìŠ¤ëŠ” Splitìœ¼ë¡œë¶€í„° ìŠ¤íŠ¸ë¦¼ì„ ì—´ì–´ Pageë¥¼ ìƒì„±í•˜ëŠ” ë‹¨ê³„ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆê³ , í…Œì´ë¸” ë°ì´í„°ë¥¼ ì½ëŠ” ê³¼ì •ì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí•œê²ƒìœ¼ë¡œ ì¶”ì¸¡í• ìˆ˜ìžˆë‹¤. ì£¼ìš” í˜¸ì¶œ ìŠ¤íƒì€ ë‹¤ìŒê³¼ ê°™ë‹¤:

- **93ë²ˆ ë¼ì¸**: `io.trino.operator.ScanFilterAndProjectOperator$SplitToPages.process()` - Splitì„ Pageë¡œ ìƒì„±
- **87ë²ˆ ë¼ì¸**: `io.trino.plugin.hive.line.LinePageSourceFactory.createPageSource()` - í…ìŠ¤íŠ¸ íŒŒì¼ì„ ì½ì–´ì„œ Reader ìƒì„±
- **83ë²ˆ ë¼ì¸**: `io.trino.filesystem.hdfs.HdfsInputFile.newStream()` - í…ìŠ¤íŠ¸ íŒŒì¼ì˜ InputStream ìƒì„±

`LinePageSourceFactory`ë¥¼ ì‚¬ìš©í•œ ê²ƒìœ¼ë¡œ ë³´ì•„ CSVë‚˜ JSON í¬ë§·ì˜ í…Œì´ë¸”ì„ ì½ëŠ” ì¤‘ì´ì—ˆë‹¤(ORC íŒŒì¼ì˜ ê²½ìš° `OrcPageSourceFactory`ë¥¼ ì‚¬ìš©í•¨).

### ì½”ë“œ ë ˆë²¨ ë¶„ì„

ì´ì œ ë¬¸ì œì˜ ë°œìƒ ì§€ì ì„ ì°¾ì•˜ìœ¼ë‹ˆ, Splitìœ¼ë¡œ Pageë¥¼ ìƒì„±í•˜ëŠ” `LinePageSourceFactory.createPageSource()` ë©”ì„œë“œë¶€í„° ìžì„¸ížˆ ì‚´íŽ´ë³´ìž.

![LinePageSourceFactory](https://github.com/user-attachments/assets/415c0837-e3db-4974-8ab7-1e0b4aa9b346)
*LineReaderë¥¼ ìƒì„±í•˜ëŠ” `LinePageSourceFactory.createLineReader()` ë©”ì„œë“œ ì½”ë“œ*

`LinePageSourceFactory.createPageSource()`ì—ì„œëŠ” ìž…ë ¥íŒŒì¼(`inputFile`)ì„ ë°›ì•„ `lineReader`ë¥¼ ìƒì„±í•œë‹¤. `TextLineReaderFactory.createLineReader()`ì—ì„œëŠ” ìž…ë ¥íŒŒì¼ì˜ ìŠ¤íŠ¸ë¦¼ì„ ìƒì„±í•œë‹¤.

![HdfsInputFile](https://github.com/user-attachments/assets/2c4b4d7f-6703-4fd6-8aa4-735b798db3b2)
*HDFS íŒŒì¼ì‹œìŠ¤í…œì—ì„œ íŒŒì¼ì„ ì—¬ëŠ” `HdfsInputFile.openFile()` ë©”ì„œë“œ*

`HdfsInputFile.openFile()`ì—ì„œëŠ” HDFS íŒŒì¼ì‹œìŠ¤í…œì—ì„œ ìž…ë ¥íŒŒì¼ì„ ì—°ë‹¤. íŒŒì¼ì„ ì—´ ë•Œ íŒŒì¼ì‹œìŠ¤í…œ ê°ì²´ê°€ í•„ìš”í•˜ë©°, ì´ íŒŒì¼ì‹œìŠ¤í…œ ê°ì²´ëŠ” `environment.getFileSystem()`ì— ì¸ìžë¡œ ì „ë‹¬í•˜ëŠ” íŒŒì¼ ê²½ë¡œ(Path ê°ì²´)ë¡œë¶€í„° ê°€ì ¸ì˜¬ìˆ˜ ìžˆë‹¤.

![core-site.xml](https://github.com/user-attachments/assets/caed0e45-abca-49e6-9415-8d35a930ed5b)
*íŒŒì¼ì‹œìŠ¤í…œê³¼ URI ìŠ¤í‚´ ë§¤í•‘ì„ ë³´ì—¬ì£¼ëŠ” Hadoop core-site.xml ì„¤ì • íŒŒì¼*

íŒŒì¼ ê²½ë¡œë¡œ íŒŒì¼ì‹œìŠ¤í…œì„ ì‹ë³„í•  ìˆ˜ ìžˆëŠ” ì´ìœ ëŠ”, íŒŒì¼ ê²½ë¡œ(URI)ì˜ ìŠ¤í‚´(scheme)ì´ íŒŒì¼ì‹œìŠ¤í…œê³¼ ë§¤í•‘ë˜ì–´ìžˆëŠ” ìœ ì¼í•œ ì‹ë³„ìžê¸° ë•Œë¬¸ì´ë‹¤. ìš°ë¦¬ëŠ” Amazon S3ë¥¼ ì˜ì¡´í•˜ê¸° ë•Œë¬¸ì— `s3://bucket_name`ìœ¼ë¡œ ì‹œìž‘í• ê²ƒì´ê³ , ì´ëŠ” EmrFileSystemê³¼ ë§¤í•‘ë˜ì–´ìžˆë‹¤.

![FileSystem](https://github.com/user-attachments/assets/2c9904e0-7e6e-446a-8933-97e03ee68e2a)

### FileSystem.get() ë©”ì„œë“œì˜ ìºì‹œ ë©”ì»¤ë‹ˆì¦˜

![FileSystem.get()](https://github.com/user-attachments/assets/8e584170-df58-4c77-8f13-ba49b18863a2)
*URIë¡œë¶€í„° íŒŒì¼ì‹œìŠ¤í…œì„ ê°€ì ¸ì˜¤ëŠ” `FileSystem.get()` ìºì‹œ ë©”ì»¤ë‹ˆì¦˜ êµ¬í˜„*

ì¸ìžë¡œ ì „ë‹¬í•˜ëŠ” `path` ê°ì²´ë¡œë¶€í„° íŒŒì¼ì‹œìŠ¤í…œì„ ê°€ì ¸ì˜¨ë‹¤. URIë¡œë¶€í„° íŒŒì¼ì‹œìŠ¤í…œì„ ê°€ì ¸ì˜¬ë•Œ ìºì‹œë¥¼ ì‚¬ìš©í•˜ë©°, ìºì‹œë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ” `fs.$SCHEME.impl`ì˜ ì„¤ì •ì— ì •ì˜ëœ í´ëž˜ìŠ¤ë¥¼ ë™ì  ë¡œë”©í•˜ëŠ” ê³¼ì •ì´ ê½¤ ë¹„ì‹¼ ì—°ì‚°ì´ê¸° ë•Œë¬¸ì— ìºì‹œë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒìœ¼ë¡œ ì¶”ì¸¡í•œë‹¤.

`fs.$SCHEME.impl.disable.cache`ì˜ ê¸°ë³¸ê°’ì´ `false`ì´ë¯€ë¡œ íŒŒì¼ì‹œìŠ¤í…œì„ `CACHE`ë¡œë¶€í„° ì¡°íšŒí•œë‹¤. ì—¬ê¸°ì„œ í…Œì´ë¸”ì„ ìŠ¤ìº”í• ë•Œ, ìŠ¤ìº”ë˜ëŠ” íŒŒì¼ í•˜ë‚˜ë‹¹ ìºì‹œë¥¼ í•œë²ˆ ì¡°íšŒí•œë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì´ `get()` í•¨ìˆ˜ëŠ” ì¿¼ë¦¬ê°€ íƒìƒ‰í•˜ëŠ” íŒŒì¼ì˜ ê°¯ìˆ˜ë§Œí¼ í˜¸ì¶œëœë‹¤.

### ìºì‹œ í‚¤ì˜ ì¹˜ëª…ì  ê²°í•¨

![Cache.Key](https://github.com/user-attachments/assets/b9391faa-ff92-4ce7-ae5a-a38594faeb1b)
*ìºì‹œ ì¡°íšŒë¥¼ ìœ„í•œ FileSystem Cache Key í´ëž˜ìŠ¤ì˜ êµ¬í˜„ì²´*

`CACHE`ë¥¼ ì¡°íšŒí•˜ê¸° ìœ„í•´ í‚¤ ê°ì²´ë¥¼ ìƒì„±í•œë‹¤. ì´ê²ƒ ì—­ì‹œ íŒŒì¼ í•˜ë‚˜ë‹¹ í•˜ë‚˜ì˜ í‚¤ê°€ ìƒì„±ëœë‹¤. ë™ì¼í•œ í…Œì´ë¸” ë°ì´í„°ì…‹ì„ êµ¬ì„±í•˜ëŠ” ê° íŒŒì¼ì— ëŒ€í•œ `Key` ê°ì²´ì˜ ë©¤ë²„ ë³€ìˆ˜ ê°’ì„ ì˜ˆìƒí•´ë³¸ë‹¤:

- **scheme**: `s3`
- **authority**: S3 ë²„í‚· ì´ë¦„ (í…Œì´ë¸”ì˜ ëª¨ë“  íŒŒì¼ì´ ë™ì¼í•œ ë²„í‚·)
- **ugi**: `UserGroupInformation.getCurrentUser()`
- **unique**: `0`

`Key`ì˜ ìƒì„±ìžì— ë„˜ì–´ì˜¤ëŠ” ì¸ìžê°’ `uri`ëŠ” íŒŒì¼ë§ˆë‹¤ ë‹¤ë¥´ê³ , `conf`ëŠ” ë™ì¼í•˜ì§€ë§Œ, í…Œì´ë¸”ì˜ íŒŒì¼ë“¤ì— ëŒ€í•œ ë©¤ë²„ ë³€ìˆ˜ ëª¨ë‘ ë™ì¼í•œ ê°’ì´ê¸° ë•Œë¬¸ì— ë™ì¼í•œ í‚¤ë¥¼ ê°€ì§ˆ ê²ƒì´ë¼ê³  ì˜ˆìƒí•œë‹¤.

### ë¬¸ì œì˜ í•µì‹¬: UserGroupInformation hashCode

ì´ Cache í´ëž˜ìŠ¤ëŠ” HashMapì„ ì‚¬ìš©í•˜ì—¬ ìºì‹œë¥¼ êµ¬í˜„í–ˆê³ , HashMapì€ `equals()`, `hashcode()`ë¥¼ ì‚¬ìš©í•˜ì—¬ í‚¤ì˜ ì¤‘ë³µì„ ê²€ì‚¬í•œë‹¤. `Key` í´ëž˜ìŠ¤ì˜ `hashcode()`ëŠ” ë©¤ë²„ ë³€ìˆ˜ì˜ í•´ì‹œì½”ë“œê°’ì„ ì¡°í•©í•˜ì—¬ ë°˜í™˜í•˜ë„ë¡ ì˜¤ë²„ë¼ì´ë“œë˜ì—ˆê³ , ê·¸ ì¤‘ì—ì„œ `ugi` ë©¤ë²„ ë³€ìˆ˜ì˜ `hashcode()`ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

![UserGroupInformation.hashcode()](https://github.com/user-attachments/assets/3f529f64-f48e-4622-bcde-e41ca8c4b8fe)
*`UserGroupInformation.hashcode()` êµ¬í˜„*

`System.identityHashCode()`ëŠ” VMì— ë”°ë¼ ë‹¤ë¥´ê²Œ êµ¬í˜„ë˜ì–´ìžˆë‹¤. Trinoê°€ ì‚¬ìš©í•˜ëŠ” Java Correto 17ì€ HotSpot VM(Open JDK)ì˜ êµ¬í˜„ì²´ë‹¤. HotSpotì˜ `System.identityHashCode()`ì€ í˜¸ì¶œí• ë•Œë§ˆë‹¤ ë‹¤ë¥¸ ê°’ì„ ë°˜í™˜í•œë‹¤.

- [The Java System::identityHashCode method](https://www.objectos.com.br/blog/the-java-system-identity-hash-code-method.html), HotSpot VMì˜ í•´ì‹œì½”ë“œ ë™ìž‘ ì„¤ëª…
- [How does the default hashCode() work?](https://varoa.net/jvm/java/openjdk/biased-locking/2017/01/30/hashCode.html)

ê²°êµ­ íŒŒì¼ë§ˆë‹¤ ë‹¤ë¥¸ í‚¤ ê°’ì„ ìƒì„±í•˜ëŠ” ê²ƒê³¼ ë§ˆì°¬ê°€ì§€ì´ë¯€ë¡œ, íŒŒì¼ í•˜ë‚˜ë‹¹ ìºì‹œì˜ ë ˆì½”ë“œë¥¼ í•˜ë‚˜ì”© ì ìœ í•˜ê²Œ ë˜ê³  ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ë¡œ ì´ì–´ì§„ë‹¤.

### ë¬¸ì œ ë°œìƒ ê³¼ì • ì •ë¦¬

1. `TextLineReaderFactory` ê°ì²´ ì‚¬ìš©ìœ¼ë¡œ JSON, CSV ê°™ì€ í…ìŠ¤íŠ¸ í¬ë§·ì˜ í…Œì´ë¸” ì¡°íšŒ ì‹œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€
2. íŒŒì¼ í•˜ë‚˜ë¥¼ ì—´ê¸° ìœ„í•´ í•´ë‹¹ íŒŒì¼ ê²½ë¡œë¡œë¶€í„° `FileSystem` ê°ì²´ë¥¼ ìºì‹œì—ì„œ ì¡°íšŒ
3. ìºì‹œ ížˆíŠ¸ê°€ ì ˆëŒ€ ë°œìƒí•˜ì§€ ì•Šì•„ íŒŒì¼ í•˜ë‚˜ë‹¹ í•˜ë‚˜ì˜ íŒŒì¼ì‹œìŠ¤í…œ ë ˆì½”ë“œê°€ `HashMap`ì— ëˆ„ì 

### ì‹¤ì œ ì¿¼ë¦¬ íŒ¨í„´ ë¶„ì„

ë¬¸ì œë¥¼ ì¼ìœ¼í‚¤ëŠ” ì‹¤ì œ ì¿¼ë¦¬ë¥¼ í™•ì¸í–ˆë‹¤:

```sql
SELECTâ€¨service_name,â€¨ip,â€¨level,â€¨count(*) AS log_count
FROM log_table -- CSV í¬ë§·ì˜ ë¡œê·¸ í…Œì´ë¸”
WHERE yyyymmddhh = ?â€¨AND timestamp >= ?â€¨AND timestamp < ?â€¨AND service_name like 'server-%'
GROUP BY service_name, ip, level
ORDER BY service_name, ip, level, log_count
```

ì´ ì¿¼ë¦¬ëŠ”:
- **5ë¶„ë§ˆë‹¤ ì‹¤í–‰**
- **JSON í¬ë§·ì˜ 1MB ì´í•˜ ìž‘ì€ íŒŒì¼ë“¤** ìŠ¤ìº”
- í•œ ë²ˆì— **ìˆ˜ë°± ê°œì˜ íŒŒì¼** ì²˜ë¦¬
- 1ì‹œê°„ì— 12ë²ˆ ë™ì¼í•œ íŒŒí‹°ì…˜ ì¡°íšŒ

## í•´ê²°: ê°„ë‹¨í•˜ì§€ë§Œ íš¨ê³¼ì ì¸ ì†”ë£¨ì…˜

### Hadoopì˜ ì˜¤ëž˜ëœ ì´ìŠˆ

[key of FileSystem inner class Cache contains UGI.hascode which uses the default hascode method, leading to the memory leak with Proxy Users](https://issues.apache.org/jira/browse/HADOOP-12707)
*Hadoop ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ì˜¤ëž˜ì „ì— ë³´ê³ ë˜ì—ˆì§€ë§Œ ì„¤ê³„ìƒ ì´ìœ ë¡œ ìˆ˜ì •ë˜ì§€ ì•Šì€ ì´ìŠˆ*

ê²°êµ­ ì´ê²ƒì€ Trino ë¬¸ì œê°€ ì•„ë‹Œ Hadoopì˜ ì´ìŠˆì˜€ë‹¤. ì˜¤ëž˜ì „ì— ì´ìŠˆë¡œ ë³´ê³ ë˜ì—ˆì§€ë§Œ ì„¤ê³„ìƒì˜ ì´ìœ ë¡œ ìˆ˜ì •ë˜ì§€ ì•Šì•˜ë‹¤. ë§Žì€ Hadoop ì—ì½”ì‹œìŠ¤í…œ ì„œë¹„ìŠ¤ë“¤(Spark, Hive ë“±)ì´ ì—¬ì „ížˆ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìžˆë‹¤.

### í•´ê²°ì±…: ìºì‹œ ë¹„í™œì„±í™”

í•´ê²°ì€ ì˜ì™¸ë¡œ ê°„ë‹¨í–ˆë‹¤. HDFS íŒŒì¼ì‹œìŠ¤í…œ ìºì‹œ ì‚¬ìš© ì—¬ë¶€ ì„¤ì •ì¸ `fs.s3.impl.disable.cache`ë¥¼ `true`ë¡œ ì„¤ì •í•˜ì—¬ ìºì‹œë¥¼ ë¹„í™œì„±í™”í–ˆë‹¤.

### ê²°ê³¼: ê·¹ì ì¸ ê°œì„ 

![G1 Old Gen After](https://github.com/user-attachments/assets/83c5b6a3-1261-46f6-b2ac-912fbc9d52cf)
![G1 Eden After](https://github.com/user-attachments/assets/a807deff-d069-49eb-924f-d576031720ff)
*ìºì‹œ ë¹„í™œì„±í™” í›„ í‰í™”ë¡œì›Œì§„ Old ì˜ì—­ê³¼ ë°”ë¹ ì§„ Young ì˜ì—­ì˜ ëª¨ìŠµ*

ìºì‹œë¥¼ ë¹„í™œì„±í™”í•œ í›„:
- **Old ì˜ì—­**: í‰í™”ë¡œì›Œì§, Major GC ë¯¸ë°œìƒ
- **Young ì˜ì—­**: ë” ë°”ë¹ ì§, Minor GC ë¹ˆë²ˆ ë°œìƒ

ì´ëŠ” ì˜ˆìƒëœ ê²°ê³¼ë¡œ, ìºì‹œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ ë§¤ë²ˆ ìƒˆë¡œìš´ `FileSystem` ê°ì²´ë¥¼ ìƒì„±í•˜ë¯€ë¡œ Young ì˜ì—­ í™œë™ì´ ì¦ê°€í–ˆì§€ë§Œ, ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ëŠ” ì™„ì „ížˆ í•´ê²°ë˜ì—ˆë‹¤.

## ê²°ë¡ ê³¼ êµí›ˆ

ì´ë²ˆ ë¬¸ì œ í•´ê²° ê³¼ì •ì—ì„œ ê°€ìž¥ í° êµí›ˆì€ ë¬¸ì œì˜ ê·¼ë³¸ ì›ì¸ì´ ì˜ˆìƒë³´ë‹¤ í›¨ì”¬ ê¹Šì€ ê³³ì— ìžˆì„ ìˆ˜ ìžˆë‹¤ëŠ” ì ì´ì—ˆë‹¤. ë‹¨ìˆœí•œ Trino ì„¤ì • ë¬¸ì œë¡œ ë³´ì˜€ë˜ ê²ƒì´ ì‹¤ì œë¡œëŠ” Hadoop íŒŒì¼ì‹œìŠ¤í…œ ìºì‹œì˜ ì„¤ê³„ ê²°í•¨ì—ì„œ ë¹„ë¡¯ëœ ê²ƒì´ì—ˆë‹¤. `UserGroupInformation` ê°ì²´ì˜ `hashCode()` êµ¬í˜„ì´ ë§¤ë²ˆ ë‹¤ë¥¸ ê°’ì„ ë°˜í™˜í•˜ì—¬ ìºì‹œê°€ ì „í˜€ ìž‘ë™í•˜ì§€ ì•ŠëŠ” ë¯¸ë¬˜í•œ ë²„ê·¸ì˜€ë‹¤. 

ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ìž‘ì€ íŒŒì¼ë“¤ë¡œ êµ¬ì„±ëœ í…Œì´ë¸” êµ¬ì¡°ê°€ ë‹¨ìˆœí•œ ì„±ëŠ¥ ë¬¸ì œë¥¼ ë„˜ì–´ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ê¹Œì§€ ì•¼ê¸°í•  ìˆ˜ ìžˆìœ¼ë©°, ìƒì„¸í•œ ëª¨ë‹ˆí„°ë§ê³¼ íž™ë¤í”„ ë¶„ì„ì´ ë¬¸ì œ í•´ê²°ì˜ í•µì‹¬ì´ë¼ëŠ” ê²ƒì„ ê¹¨ë‹¬ì•˜ë‹¤. ì•žìœ¼ë¡œëŠ” ì•Œë ¤ì§„ ì•ˆí‹°íŒ¨í„´ë“¤ì„ ì‚¬ì „ì— ë°©ì§€í•˜ëŠ” ì•„í‚¤í…ì²˜ë¥¼ ì„¤ê³„í•˜ê³ , ê°„ë‹¨í•œ ì„¤ì • í•˜ë‚˜ê°€ ì‹œìŠ¤í…œ ì „ì²´ì˜ ì•ˆì •ì„±ì„ ì¢Œìš°í•  ìˆ˜ ìžˆë‹¤ëŠ” ì ì„ í•­ìƒ ì—¼ë‘ì— ë‘ê³  ìš´ì˜í•´ì•¼ê² ë‹¤.







